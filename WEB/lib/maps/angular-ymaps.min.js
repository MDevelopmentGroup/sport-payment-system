angular.module("ymaps",[]).factory("$script",["$q","$rootScope",function(a,b){"use strict";function c(a,b){var c=document.createElement("script");c.onload=c.onreadystatechange=function(){c.readyState&&"complete"!==c.readyState&&"loaded"!==c.readyState||(c.onload=c.onreadystatechange=null,angular.isFunction(b)&&b())},c.async=!0,c.src=a,document.getElementsByTagName("body")[0].appendChild(c)}var d=[],e={};return function(f){var g=a.defer();if(-1!==d.indexOf(f))g.resolve();else{if(e[f])return e[f];c(f,function(){delete e[f],d.push(f),b.$apply(function(){g.resolve()})}),e[f]=g.promise}return g.promise}}]).factory("ymapsLoader",["$window","$timeout","$script","ymapsConfig",function(a,b,c,d){"use strict";var e;return{ready:function(f){e||(e=c(d.apiUrl).then(function(){return a.ymaps})),e.then(function(a){a.ready(function(){b(function(){f(a)})})})}}}]).constant("ymapsConfig",{apiUrl:"//api-maps.yandex.ru/2.0-stable/?load=package.standard,package.clusters&mode=release&lang=ru-RU&ns=ymaps",mapBehaviors:["default"],markerOptions:{preset:"twirl#darkgreenIcon"},fitMarkers:!0}).value("debounce",function(a,b){"use strict";var c=null;return function(){var d=this,e=arguments,f=function(){c=null,a.apply(d,e)};clearTimeout(c),c=setTimeout(f,b)}}).controller("YmapController",["$scope","$element","ymapsLoader","ymapsConfig","debounce",function(a,b,c,d,e){"use strict";function f(a,b){var c=.1,d=e(function(d){if(b.getLength()>0){var e=d.get("newBounds"),f=[e[1][0]+c,e[1][1]+c],g=[e[0][0]-c,e[0][1]-c];a.setBounds([g,f],{checkZoomRange:!0})}},100);b.events.add("boundschange",d)}var g=this;c.ready(function(c){g.addMarker=function(b,d){var e=new c.Placemark(b,d);return a.markers.add(e),e},g.removeMarker=function(b){a.markers.remove(b)},g.map=new c.Map(b[0],{center:a.center||[0,0],zoom:a.zoom||0,behaviors:d.mapBehaviors}),g.map.controls.add("zoomControl",{right:5,top:10}),a.markers=new c.GeoObjectCollection({},d.markerOptions),g.map.geoObjects.add(a.markers),d.fitMarkers&&f(g.map,a.markers);var e;a.$watch("center",function(a){e||g.map.panTo(a)},!0),a.$watch("zoom",function(a){e||g.map.setZoom(a,{checkZoomRange:!0})}),g.map.events.add("boundschange",function(b){e=!0,a.$apply(function(){a.center=b.get("newCenter"),a.zoom=b.get("newZoom")}),e=!1})})}]).directive("yandexMap",["$compile","ymapsLoader",function(a,b){"use strict";return{restrict:"EA",scope:{center:"=",zoom:"="},compile:function(c){var d=c.html();return c.html(""),function(c,e){b.ready(function(){d=angular.element("<div></div>").html(d).contents(),e.append(d),a(d)(c.$parent)})}},controller:"YmapController"}}]).directive("ymapMarker",function(){"use strict";return{restrict:"EA",require:"^yandexMap",scope:{coordinates:"=",index:"=",properties:"="},link:function(a,b,c,d){function e(){var b=[parseFloat(a.coordinates[0]),parseFloat(a.coordinates[1])];f?f.geometry.setCoordinates(b):f=d.addMarker(b,angular.extend({iconContent:a.index},a.properties))}var f;a.$watch("index",function(a){f&&f.properties.set("iconContent",a)}),a.$watch("coordinates",function(a){a&&e()},!0),a.$on("$destroy",function(){f&&d.removeMarker(f)})}}});